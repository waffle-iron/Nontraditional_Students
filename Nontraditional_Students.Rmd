---
title: "Defining Non-Traditional Students"
author: "Alex Axthelm"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: zenburn
    theme: readable
    toc: yes
    toc_float: yes
  flexdashboard::flex_dashboard:
    orientation: columns
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

```{r setup_variables, include = FALSE, cache = FALSE}
is_draft <- TRUE

use_live_sql <- if (Sys.getenv("CONTINUOUS_INTEGRATION") == "true"){
  FALSE
} else {
  TRUE
  # FALSE
}
show_sql_code <- (use_live_sql & is_draft)

set.seed(20170419)
ptm <- proc.time()[3]
project_sql_server <- "CHESQLP01VW"
excel_list <- list()
```

```{r load_packages, cache = FALSE, message = FALSE, echo = FALSE, include = FALSE}
library(knitr)
library(DT)
library(plotly)
library(tidyverse)
library(DBI)
library(htmltools)
library(broom)
library(openxlsx)
if (use_live_sql) {library(odbc)}
library(RSQLite)
library(openssl)
library(git2r)
library(PKI)
library(secure) # This should be Hadley's secure, not the one from CRAN
```

```{r set_knitr_options, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  message = is_draft,
  warning = is_draft,
  autodep = TRUE
  )
```

```{r git_info, include = is_draft, cache = FALSE}
if (Sys.getenv("CONTINUOUS_INTEGRATION") == "true") {
  git_info <- NULL
} else {
  git_info <- as(git2r::lookup(
    repo = repository(),
    sha = branch_target(head(repository()))
    ),
  "data.frame"
  )
}
```

```{r UsefulInfo, results = "hold", include = is_draft, eval = is_draft, cache = FALSE}
print("Draft Information")
print("Working Directory")
print(getwd())
if (!is_null(git_info)) {
  print("GIT:")
  print(substr(x = git_info$sha, start = 0, stop = 6))
  print(git_info$summary)
  print(git_info$when)

}

```

```{r load_sample_data, include = !show_sql_code, eval = !use_live_sql}
# This will only load the encrypted subset of data
if (secure::has_key()) {
  data_processed_alpha <- decrypt("dpa")[[1]]
} else {
  localname <- paste0(Sys.getenv("USERNAME"), "@", Sys.getenv("computername"))
  print(paste("Adding User:", localname ,"to Secure Vault"))
  secure::add_user(
    name = localname,
    public_key = local_key()
    )
}
```

```{r Prepare_SQL_connection, include = show_sql_code, eval = TRUE}
if (use_live_sql) {
  dbcon <- odbc::dbConnect(
    drv = odbc::odbc(),
    driver = "SQL Server",
    server = project_sql_server,
    database = "CHEDW",
    trusted_connection = TRUE
    )
} else {
  dbcon <- dbConnect(RSQLite::SQLite(), ":memory:")
}
```

```{sql SQL_raw_ite_data, output.var = "raw_ite_data", include = show_sql_code, eval = use_live_sql, connection = dbcon}
SELECT
  s.CurrentCSN,
  ite.TermKey,
  dt.FiscalYearKey,
  dt.TermCode,
  ite.LocationKey,
  ite.ProgramMajorKey,
  ite.StudentFAStatusKey,
  ite.TransferCredit,
  ite.OtherAlternativeCredit,
  ite.UnderGradCreditEoT,
  ite.GradCreditEoT,
  ite.ProfPracticeCreditEoT,
  ite.UnderGradCreditCensus,
  ite.GradCreditCensus,
  ite.ProfPracticeCreditCensus,
  ite.DualCreditTotalCreditEoT
FROM CHEDW.dw.DimStudent AS s
INNER JOIN CHEDW.dw.FactInstTermEnrollment AS ite ON (ite.StudentKey = s.StudentKey)
LEFT JOIN CHEDW.dw.DimTerm AS dt ON (dt.TermKey = ite.TermKey)
```


```{r include = show_sql_code, eval = use_live_sql}
data_processed_alpha <- raw_ite_data %>%
  mutate(
    is_undergrad = UnderGradCreditEoT >0,
    is_grad = GradCreditEoT >0,
    is_prof_practice = ProfPracticeCreditEoT > 0,
    is_dual_credit = DualCreditTotalCreditEoT > 0,
    is_guest = (UnderGradCreditEoT + UnderGradCreditCensus == 0
                & GradCreditEoT + GradCreditCensus == 0
                & ProfPracticeCreditEoT + ProfPracticeCreditCensus == 0
                & DualCreditTotalCreditEoT == 0
    ),
    is_drop = case_when(
      .$UnderGradCreditCensus > 0 & .$UnderGradCreditEoT == 0 ~ "Undergrad",
      .$GradCreditCensus > 0 & .$GradCreditEoT == 0 ~ "Grad",
      .$ProfPracticeCreditCensus > 0 & .$ProfPracticeCreditEoT == 0 ~ "ProfPractice",
      TRUE ~ NA_character_
    ),
    has_incoming_credit = (OtherAlternativeCredit > 0) | (TransferCredit > 0)
    )
```

```{r save_sample_data_block, include = FALSE, eval = use_live_sql}
# This block is here to make my life easier so that when I am on my local machine, I can create an up to date set of sample data for Travis.
random_csn_vec <- sample(x = data_processed_alpha$CurrentCSN, size = 10000) # Pick 10000 students at random
dpa <- data_processed_alpha %>% filter(CurrentCSN %in% random_csn_vec)

if (file.exists("vault/dpa.rds.enc")) {file.remove("vault/dpa.rds.enc")}
secure::encrypt("dpa", secret = dpa)
remove(dpa)
```

```{r}
overlap <- data_processed_alpha %>%
  group_by(is_undergrad, is_grad, is_prof_practice, is_dual_credit, is_guest, is_drop) %>%
  summarise(num = n())

datatable(overlap)
```
Here we can see that there all dual credit students are also counted as undergrad credits (which makes sense), but other types of credit are distinct.

# FAFSA Information

Let's try loading in useful (self-reported) information from each student's FAFSA.

```{r Prepare_GRADS_SQL_connection, include = show_sql_code, eval = TRUE}
if (use_live_sql) {
  grads_con <- odbc::dbConnect(
    drv = odbc::odbc(),
    driver = "SQL Server",
    server = "IOTSQLP23vw\\P23vwiotPROD",
    database = "GRADS",
    trusted_connection = TRUE
    )
} else {
  dbcon <- dbConnect(RSQLite::SQLite(), ":memory:")
}
```
```{sql SQL_raw_GRADS_data, output.var = "raw_GRADS_data", include = show_sql_code, eval = use_live_sql, connection = grads_con}
SELECT
  in_AppId,
  ch_BusYear,
  ch_SSN AS DS01,
  ch_StuCitizenshipCd,
  ti_FirstBachDegreeFlg,
  ti_StuMaritalStatusCd,
  ti_StuBornBeforeFlg,
  ti_USVeteranFlg,
  ti_GradStuFlg,
  ti_StuMarriedFlg,
  ti_StuOthrDependFlg,
  ti_OrphanWardFlg,
  ti_InterestStuJobFlg,
  ti_InterestStuLoanFlg,
  ch_GEDEarned,
  ti_FthEduLevelCd,
  ti_MthEduLevelCd,
  ch_PellEligibilityFlg,
  ch_DependStatusCd -- Is dependent
FROM GRADS.dbo.Application
```

```{sql SQL_raw_psm_data, output.var = "raw_psm_data", include = show_sql_code, eval = use_live_sql, connection = dbcon}
SELECT DISTINCT
  DS01,
  CurrentCSN
FROM CHEDW.research.PostsecondaryMaster
```

```{r include = show_sql_code, eval = use_live_sql}
data_processed_fafsa <- raw_GRADS_data %>%
  left_join(raw_psm_data, by = "DS01") %>%
  select(-DS01)

```

```{r save_sample_data_block_fafsa, include = FALSE, eval = use_live_sql}
# This block is here to make my life easier so that when I am on my local machine, I can create an up to date set of sample data for Travis.
dpf <- data_processed_fafsa %>% filter(CurrentCSN %in% random_csn_vec)

if (file.exists("vault/dpf.rds.enc")) {file.remove("vault/dpf.rds.enc")}
secure::encrypt("dpf", secret = dpf)
remove(dpf)
```
